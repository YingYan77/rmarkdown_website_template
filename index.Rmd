---
title: "My Website"
---

Hello, Website!

For more information about simple R Markdown websites, please read the documentation at https://bookdown.org/yihui/rmarkdown/rmarkdown-site.html.

Please also note that simple R Markdown sites are _not_ based on **blogdown**. They are probably good for websites with only a few Rmd documents. For larger-scale and more sophisticated websites (such as blogs), you may want to use **blogdown** instead: https://github.com/rstudio/blogdown.

---
title: "TOSCO2.0 Coding Progress Analysis"
author: "Ying Yan"
date: "Last update: 2023-08-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(sf)
library(wbstats)
library(tidyverse)
library(ggplot2)
library(scales)
library(lubridate)
library(highcharter) 
```

```{r load data, echo=FALSE}
## empty memory (!)
rm(list=ls())

## read data
tosco2 <- read.csv("tosco2_updating.csv")
progress <- read.csv("coding_progress.csv")
```

This page contains several graphs describing current TOSCO2.0 coding progress, aiming to showing current coding stage and enhancing coding efficiency. The data in use is [tosco2 updating data file](https://github.com/SeraphineM/tosco/blob/main/tosco-updating/tosco2_updating.csv) and ISP company allocation table on the [Github landing page](https://github.com/SeraphineM/tosco/blob/main/tosco%20coding/README.md). 

## Aggregated Progress Overview

Two graphs below provides an overview of current coding progress in the unit of ISP company. 

```{r Create the coding progress variable, echo=FALSE, message=FALSE, warning=FALSE}
## classify the coding progress of each company
company_id <- unique(tosco2[nchar(as.character(tosco2$company_id))==4,]$company_id)
status <- rep("coded", length(company_id))
company_coded <- as.data.frame(cbind(company_id, status))

progress_status <- left_join(progress, company_coded, by="company_id") %>% 
  mutate(code_status = case_when(
    coder_name == "Ceased" ~ "Coded", 
    status == "coded" ~ "Coded", 
    !is.na(coder_name) & is.na(status) ~ "Coding", 
    is.na(coder_name) & is.na(status) ~ "To be code"))

progress_status$code_status[5] <- "Coded"

```

### Overview
In total there are 197 ISP companies in the coding list at the [landing page](https://github.com/SeraphineM/tosco/blob/main/tosco%20coding/README.md), which need to be checked for any updates. The following pie chart shows below information:

- Up to 25 August, **60.9%** (120 out of 197) of those companies have been either coded or checked as ceased. 
- **13.2%** (i.e. 26) of companies have been taken by a coder but its corresponding data haven't been updated in the tosco2_updating file. 
- This left 51 companies (**25.9%**) waited to be code. 

```{r Aggregated Pie Chart, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
## coding progress grouping
agg_progress <- progress_status %>% group_by(code_status) %>% 
  summarise(n=n()) %>% 
  mutate(freq = round(n / sum(n), 3)*100)

## draw the pie chart of coding progress
agg_progress %>%
  hchart(
    "pie", hcaes(x = code_status, y = n),
    name = "Coding Status") %>% 
  hc_colors(c("#8C7527", "#D7A207", "#E5E2D5")) %>% 
  hc_plotOptions(pie = list(
    dataLabels = list(enabled = TRUE), 
    tooltip = list(pointFormat = "{series.name}: {point.freq:.1f}% ({point.n})"))) %>% 
  hc_title(
    text = "Aggregated Coding Progress (based on ISPs)"
  )
```

### By country

This map shows the completeness regarding the coding level of each country's ISP company in percentage. 100% means that all ISP companies in this country has been coded, whereas 0% means that none of the ISP companies in this country has been coded. 

The bracket in the tooltip also shows the total number of ISP companies in a certain country, and how many companies there has been coded so far. 

```{r Map the coding progress, echo=FALSE, message=FALSE, warning=FALSE}
## change the name to match the dataset
progress_status$country <- gsub("Congo Kinshasa", "Democratic Republic of the Congo", progress_status$country)
progress_status$country <- gsub("Congo Brazzaville", "Republic of Congo", progress_status$country)
progress_status$country <- gsub("Tanzania", "United Republic of Tanzania", progress_status$country)
progress_status$country <- gsub("Guinea-Bissau", "Guinea Bissau", progress_status$country)

## create the country-based progress percentage variable
all_ISP <- progress_status %>% group_by(country) %>% summarise(total_number=n()) 
done_ISP <- progress_status %>% 
  filter(code_status=="Coded") %>% 
  group_by(country) %>% 
  summarise(finished = n())

progress_pert <- left_join(all_ISP, done_ISP, by="country") %>% 
  mutate(ratio = ifelse(is.na(finished), 0, round((finished / total_number)*100, 3)))

## draw the map
hcmap(
  map = "custom/africa", 
  showInLegend = FALSE, 
  data = progress_pert, 
  joinBy = c("name","country"),
  name = "Progress status",
  value = "ratio",
  tooltip = list(pointFormat = "{point.name} {point.value:.2f}% ({point.finished}/{point.total_number})"),
  dataLabels = list(enabled = TRUE, format = "{point.country}")
) |>
  hc_title(text = "Coding Progress by Country (%)") |> 
  hc_colorAxis(
    minColor = "#E5E2D5",
    maxColor = "#8C7527"
  ) |> 
  hc_mapNavigation(enabled = TRUE) |>
  hc_size(width = 900, height = 600)


```

## Correction Required

This Bar chart gives a summary of the number of data points that need to be corrected later on, which is marked as "company_id" plus '_correct' when we use the Google form to collect data. 

- Currently there are **28** observations that need to be overwritten by its corrected-version in tosco2 updating dataset. 
- So far we've coded **936** rows, ignoring the additional correction rows. 

```{r Correction bar chart, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
correct <- grep("_correct$|-correct$", tosco2$company_id, value = TRUE)

correct <- unique(substr(correct, 0, 4))

tosco2 <- tosco2 %>% mutate(correct_needed = case_when(
  str_detect(company_id, "_correct") ~ "Yes", 
  str_detect(company_id, "-correct") ~ "Yes"))

tosco2$correct_needed[is.na(tosco2$correct_needed)] = "No"

correct_needed <- tosco2 %>% group_by(correct_needed) %>% 
  summarise(n=n()) %>% mutate(freq = round(n / sum(n), 3))

correct_needed %>% hchart(type = "bar",
                          hcaes(x = correct_needed, y = n), 
                          name = "Correction Needed") %>%
  hc_colors(c("#AFB0B2", "#110F14")) %>% 
  hc_plotOptions(
    bar = list(
      colorByPoint = TRUE
    )) %>%
  hc_title(
    text = "Whether a later correction needed"
  ) %>%
  hc_xAxis(
    title = list(text = "")) %>% 
  hc_yAxis(
    title = list(text = "Number of Observation"))
```


## Coding Progress Over Time

Following bar chart shows the break-down summary of number of data entries has been coded each month, grouped by coder and excluding corrected data. Note each ISP company may have multiple data entries for a given year. 

**July** and **May** have the highest volume of data entry (more than 200 entries each). 

```{r date data clean, echo=FALSE, warning=FALSE}
# Function to convert date strings with timestamps
convert_with_timestamp <- function(date_str) {
  parsed_date <- dmy_hms(date_str, truncated = 1)
  formatted_date <- format(parsed_date, "%Y-%m-%d")
  return(formatted_date)
}

# Function to convert date strings without timestamps
convert_without_timestamp <- function(date_str) {
  if (grepl("/", date_str)) {
    parsed_date <- dmy(date_str, truncated = 1)
  } else {
    parsed_date <- dmy(date_str, truncated = 1)
  }
  formatted_date <- format(parsed_date, "%Y-%m-%d")
  return(formatted_date)
}

# Function to convert Excel serial numbers to date
convert_excel_serial <- function(serial_number) {
  converted_date <- as.Date("1900-01-01") + serial_number - 1
  formatted_date <- format(converted_date, "%Y-%m-%d")
  return(formatted_date)
}

# Apply the appropriate conversion function based on date format type
tosco2$date_column_formatted <- sapply(tosco2$Zeitstempel, function(date_str) {
  if (grepl("\\d{2}:\\d{2}:\\d{2}", date_str)) {
    convert_with_timestamp(date_str)
  } else if (grepl("\\d{5}", date_str)) {
    convert_excel_serial(as.numeric(date_str))
  } else {
    convert_without_timestamp(date_str)
  }
}) #now we should get a uniform date format

tosco2 <- tosco2 %>% rename("coder_name" = "Please.indicate.your.first.name")

# Clean a NA date
tosco2$date_column_formatted <- ifelse(is.na(tosco2$date_column_formatted), format(as.Date("2023-07-15"), "%Y-%m-%d"), tosco2$date_column_formatted)
tosco2$coder_name <- ifelse(tosco2$coder_name==2021, "Vera", tosco2$coder_name)
tosco2$company_id <- ifelse(tosco2$company_id=="Etisalat Egypt", "EGY1", tosco2$company_id)
```


```{r get new dataset, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
# Reformat and add the month column
tosco2$date_column_formatted <- ymd(tosco2$date_column_formatted)
tosco2$month <- month(ymd(tosco2$date_column_formatted))

timeseries <- tosco2 %>% 
  filter(!grepl('correct', company_id)) %>% 
  group_by(month, coder_name) %>% 
  summarise(n=n())

month_name <- c("Dec","Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep")

timeseries %>% arrange(desc(month)) %>% hchart(
  'column', hcaes(x = 'month', y = 'n', group = 'coder_name'), 
  stacking = "normal"
) %>% hc_yAxis(
  title = list(text = "Data entries")
) %>% hc_xAxis(
  title = list(text = "Month"), 
  categories = month_name
) %>%
  hc_title(
    text = "Number of Data Entries Coded per Month and Coder"
)

```


## Vadility Check

Another point need to be noticed is the need for validity check later. This section summarize this issue. 

```{r clean the variable, echo=FALSE, message=FALSE, warning=FALSE}
tosco2 <- tosco2 %>% rename("validity_check" = "Based.on.your.coding.experience.for.this.particular.year.of.the.ISP.company..is.a.validity.check.more.needed.than.elsewhere.")

tosco2 <- tosco2 %>% mutate(validity_check_needed = case_when(
  startsWith(validity_check, "Yes") ~ "Yes",
  startsWith(validity_check, "YES") ~ "Yes",
  startsWith(validity_check, "yes") ~ "Yes",
  startsWith(validity_check, "No") ~ "No",
  startsWith(validity_check, "no") ~ "No"
))

tosco2$validity_check_needed[is.na(tosco2$validity_check_needed)] = "No"
```

### Pie and Waterfall Chart for Vadility Check
First, this is an overall view of the number of data entries that need vadility check. There are in total **84** data points need validity check, which account for **9%** of coded data, excluding the correction data. They are distributed quite evenly over years, similar to those data that do not need validity check. 

```{r the validity summary, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
validity_check_table <- tosco2 %>% 
  filter(!grepl('correct', company_id)) %>%
  group_by(validity_check_needed) %>% 
  summarise(n=n()) %>% mutate(freq = round(n / sum(n), 3)*100)

validity_check <- tosco2 %>% 
  filter(!grepl('correct', company_id)) %>%
  group_by(year, validity_check_needed) %>% 
  summarise(n=n())

## combine two charts
highchart() |>  
  hc_add_series(
    validity_check, 
    "waterfall",
    hcaes(
      x = year,
      y = n, 
      group = validity_check_needed
    )
    #name = "Validity Check"
  ) |>   
  hc_add_series(
    validity_check_table,
    "pie",
    hcaes(
      x = validity_check_needed, 
      y = n
    ), 
    name = "Aggregated pie") |>   
  hc_plotOptions(
    series = list(
      showInLegend = TRUE,
      pointFormat = "{point.y}%"
      #colorByPoint = FALSE
    ),
    pie = list(
      center = c('20%', '20%'),
      colors = c("#8EAABC", "#163A5F"),
      showInLegend = FALSE,
      size = 120,
      dataLabels = list(enabled = TRUE), 
      tooltip = list(pointFormat = "{series.name}: {point.freq:.1f}% ({point.n})")
    )) |>  
  hc_colors(c("#8EAABC", "#163A5F")) |>
  hc_title(
    text = "Number of Data Entries that Validity Check"
  )


```

### Companies and countries for Vadility Check
Last but not least, here is a visualization of all those companies that contains data need validity check, grouped by corresponding countries. The size of the bubble is decided by the number of validity-check-needed data pointed in each company and country. Apparently, the information about telecom companies in **Somalia** and **Nigeria** are the most difficult to find out and check from the Internet. 

```{r the validity companies, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center'}
## create the bubble data
validity_check_list <- tosco2 %>% 
  filter(!grepl('correct', company_id)) %>%
  filter(validity_check_needed == "Yes") %>% 
  group_by(country, company_id) %>% 
  summarise(need_validity_check=n())

## plot
validity_check_list %>% 
  hchart("packedbubble", 
         hcaes(name = "company_id", 
               value = "need_validity_check", 
               group = "country")) %>% 
  hc_tooltip(
    useHTML = TRUE,
    pointFormat = "<b>{point.name}:</b> {point.value}"
  ) %>% 
  hc_plotOptions(
    packedbubble = list(
      maxSize = "75%",
      zMin = 0,
      layoutAlgorithm = list(
        gravitationalConstant =  0.05,
        splitSeries =  TRUE, # TRUE to group points
        seriesInteraction = TRUE,
        dragBetweenSeries = TRUE,
        parentNodeLimit = TRUE
      ),
      dataLabels = list(
        enabled = TRUE,
        format = "{point.name}",
        style = list(
          color = "black",
          textOutline = "none",
          fontWeight = "normal"
        )
      ), 
      series = list(
        showInLegend = FALSE,
        pointFormat = "{point.y}%"
      )
    )
  ) %>%
  hc_title(
    text = "ISP Companies That Need Validity Check"
  )


```


